# Подготовка виртуальной машины

## Склонируйте репозиторий

Склонируйте репозиторий проекта:

```
git clone https://github.com/yandex-praktikum/mle-project-sprint-4-v001.git
```

## Активируйте виртуальное окружение

Используйте то же самое виртуальное окружение, что и созданное для работы с уроками. Если его не существует, то его следует создать.

Создать новое виртуальное окружение можно командой:

```
python3 -m venv env_recsys_start
```

После его инициализации следующей командой

```
. env_recsys_start/bin/activate
```

установите в него необходимые Python-пакеты следующей командой

```
pip install -r requirements.txt
```

### Скачайте файлы с данными

Для начала работы понадобится три файла с данными:
- [tracks.parquet](https://storage.yandexcloud.net/mle-data/ym/tracks.parquet)
- [catalog_names.parquet](https://storage.yandexcloud.net/mle-data/ym/catalog_names.parquet)
- [interactions.parquet](https://storage.yandexcloud.net/mle-data/ym/interactions.parquet)
 
Скачайте их в директорию локального репозитория. Для удобства вы можете воспользоваться командой wget:

```
wget https://storage.yandexcloud.net/mle-data/ym/tracks.parquet

wget https://storage.yandexcloud.net/mle-data/ym/catalog_names.parquet

wget https://storage.yandexcloud.net/mle-data/ym/interactions.parquet
```

## Запустите Jupyter Lab

Запустите Jupyter Lab в командной строке

```
jupyter lab --ip=0.0.0.0 --no-browser
```

# Расчёт рекомендаций

Код для выполнения первой части проекта находится в файле `recommendations.ipynb`. Изначально, это шаблон. Используйте его для выполнения первой части проекта.

# Загрузка расчетных данных

Перед запуском сервиса убедитесь, что файлы рекомендаций и кодификаций находятся в нужных разделах.

Эти данные вы можете получить в ходе расчетов в Jupyter Lab используя recommendations.ipynb, либо скачать с S3 (recsys/data/)

 - cat.parquet
 - items_frac.parquet
 - recommendations.parquet
 - similar_items.parquet
 - top_recs.parquet

1. Для запуска и тестирования сервиса без использования docker-compose и без запуска веб-интерфейса файлы необходимо разместить в корневом разделе проекта

2. Для запуска сервиса с поддержкой docker-compose и веб-интерфейса файлы необходимо разместить в разделе data/

# Сервис рекомендаций

Код сервиса рекомендаций находится в файле `recommendations_service.py`.

Перейдите в корневой раздел проекта и активируйте виртуальное окружение
```
cd /home/mle-user/mle_projects/mle-recsys-project
source .venv_project_4/bin/activate
```
Сервис выполнен в двух вариантах с поддержкой веб-интерфейса (Streamlit) и без

1. Запуск сервиса без поддержки веб-интерфейса.

Каждую следующую команду необходимо запускать из нового терминала из коренвого раздела проекта:

```
uvicorn recommendation_service:app 
```
```
uvicorn features_service:app --port 8010
```
```
uvicorn events_service:app --port 8020
```

Для остановки микросервисов поочередно в соответсвующем терминале нажмите Ctrl+C

2. Запуск сервиса с поддержкой docker-compose и веб-интерфейса (Streamlit)
```
docker-compose up --build
```
Откройте браузер и перейдите по адресу http://localhost:8501

Остановка сервиса и удаление томов данных выполняется командой
```
docker-compose down --volumes
```
После завершения работы с doker удалите все созданные контейнеры и образы

Если вы хотите увидеть все контейнеры, включая остановленные, используйте команду:
```
docker ps -a
```
Удаление всех остановленных контейнеров:
```
docker container prune
```
Если нужно удалить конкретный контейнер, даже если он остановлен, используйте его ID или имя:
```
docker rm my-container
```
Для удаления образа сначала получите список всех образов с их именами и ID:
```
docker images
```
Удаление выборочного образа по имени или ID, можно указать списком через пробел:
```
docker rmi d1e3e1234567 a5c4d1234567
```
# Инструкции для тестирования сервиса

1. Код для тестирования сервиса без поддрежки веб-интерфейса находится в файле `test_service.py`.
Для запуска скрипта выолните команду в новом терминале в коренвом разделе проекта
```
python test_service.py
```
По итогу выполнения скрипта в коренвом разделе формируется файл с логами test_service.log

2. Тестирование кода с веб-интерфейсом происходит из веб-интерфейса. 
Откройте браузер и перейдите по адресу http://localhost:8501

# Стратегия смешивания онлайн- и офлайн-рекомендаций

## Разделение хранилищ данных:

Event Store: используется для хранения последних событий взаимодействия пользователя с системой (положительный отклик на трек). Это хранилище оптимизировано для быстрой записи и чтения данных, необходимых для генерации онлайн-рекомендаций.
Feature Store: хранит признаки, используемые алгоритмами рекомендаций. Эти признаки могут обновляться в реальном времени на основе новых взаимодействий пользователя.

## Использование отдельных алгоритмов для разных типов рекомендаций:

Офлайн-рекомендации: основаны на анализе длительной истории взаимодействий пользователя. Для их генерации используются большие данные, что позволяет учитывать долгосрочные интересы пользователя.
Онлайн-рекомендации: генерируются в реальном времени на основе последних трех действий пользователя. Используются небольшие объемы данных, что позволяет быстро адаптироваться к изменениям интересов пользователя.

## Смешивание рекомендаций:

Рекомендации от разных алгоритмов чередуются: онлайн-рекомендации занимают нечетные позиции, а офлайн-рекомендации — четные.
Удаление дубликатов: для обеспечения уникальности выдачи, система удаляет повторяющиеся элементы из комбинированного списка рекомендаций.
Удаление элементов из выдачи, с которыми недавно было взаимодействие.